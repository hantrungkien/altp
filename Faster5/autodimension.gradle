import org.w3c.dom.Document
import org.w3c.dom.Element
import org.w3c.dom.Node
import org.w3c.dom.NodeList

import javax.xml.parsers.DocumentBuilder
import javax.xml.parsers.DocumentBuilderFactory

//How to user
//For user module:  ./gradlew :user:createDimen
//For okan module:  ./gradlew :user:createDimen

public class DimenFactory extends DefaultTask {
    @Input
    int fromDimen = 300;
    @Input
    int[] dimens = [320, 360, 384, 411, 480, 540, 600, 800, 1024, 1280];

    @Input
    String dimenFileName = "values/dimen.xml"

    String resFolder = project.getProjectDir().getPath() + "/src/main/res/"

    @TaskAction
    def create() {
        println "Start convert dimen from value file to other screen size";
        String path = resFolder + dimenFileName;
        Map<String, String> pairs = new HashMap<>();
        try {
            File fXmlFile = new File(path);
            DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();
            DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();
            Document doc = dBuilder.parse(fXmlFile);
            doc.getDocumentElement().normalize();

            NodeList nList = doc.getElementsByTagName("dimen");
            for (int temp = 0; temp < nList.getLength(); temp++) {
                Node nNode = nList.item(temp);
                if (nNode.getNodeType() == Node.ELEMENT_NODE) {
                    Element eElement = (Element) nNode;
                    pairs.put(eElement.getAttribute("name"), eElement.getTextContent())
                }
            }

            Map<String, Double> dps = new HashMap<>();
            Map<String, Double> sps = new HashMap<>();

            for (Map.Entry<String, String> entry : pairs) {
                String mVal = entry.getValue();
                mVal = mVal.replaceAll("dp", "").replaceAll("sp", "");
                double val = Double.parseDouble(mVal);
                if (entry.getValue().contains("dp")) {
                    dps.put(entry.getKey(), val);
                } else {
                    sps.put(entry.getKey(), val);
                }
            }
            //Sort
            dps = new TreeMap<>(dps);
            sps = new TreeMap<>(sps);

            for(int dimen: dimens){
                String screenSize = "values-sw" + (int) dimen + "dp";
                String folder = resFolder + screenSize;
                String fileName = folder + "/auto_dimens.xml";
                new File(folder).mkdir();
                new File(fileName).createNewFile();
                PrintWriter printWriter = new PrintWriter(fileName);
                printWriter.println("<?xml version=\"1.0\" encoding=\"utf-8\"?>");
                printWriter.println("<resources>");
                for (Map.Entry<String, Double> entry : dps) {
                    double ratio = entry.getValue() / fromDimen;
                    double sdp = ratio * dimen;
                    printWriter.printf("\t<dimen name=\"%s\">%.2fdp</dimen>\r\n", entry.getKey(), sdp);
                }
                for (Map.Entry<String, Double> entry : sps) {
                    double ratio = entry.getValue() / fromDimen;
                    double sdp = ratio * dimen;
                    printWriter.printf("\t<dimen name=\"%s\">%.2fsp</dimen>\r\n", entry.getKey(), sdp);
                }
                printWriter.printf("\t<string name=\"debug_res\">%s</string>\r\n", screenSize);
                printWriter.println("</resources>");
                printWriter.close();
            }
        } catch (Exception e) {
            println e.getMessage();
        }
    }
}


task createDimen(type: DimenFactory) {
}

createDimen {
    dimens = [320, 360, 384, 411, 480, 540, 600, 800, 1024, 1280];
    fromDimen = 360
    dimenFileName = 'values/dimens.xml'
}